/*
* Copyright (c) 2015 Amazon.com. All rights reserved. 
*/
/*!
 * Kindle software Copyright (c) 2023 Amazon.com, Inc. or its affiliates.
 * All rights reserved. Amazon, the Amazon logo, Kindle, the Kindle logo, and Whispersync are trademarks
 * of Amazon.com, Inc. or its affiliates.
 */(()=>{var t,e,o={7073:t=>{function e(t){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}e.keys=()=>[],e.resolve=e,e.id=7073,t.exports=e},7416:(t,e,o)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.App=void 0;const r=o(5674),a=o(7909),s=o(6795),l=o(5634),c=o(9242),i=o(406),n=o(7457);e.App=class{constructor(){this.outputMetricsData={fatal:!1,statusList:[]}}async start(t,e,o){try{try{const e=i(c.settings.max_concurrency),r=t.workList.map(((r,a)=>e((()=>this.processTask({...r,tempDirectory:o,index:a,additionalInfo:t.additionalInfo})))));await Promise.all(r)}catch(t){this.outputMetricsData.fatal=!0,console.error(t)}await r.ensureFile(e),r.writeFileSync(e,JSON.stringify(this.outputMetricsData))}catch(t){console.error(t)}}async processTask(t){const e=a.TaskFactory.getProcessor(t);if(e){const o=s.Helper.getChromiumExecutablePath();let r=null,a=null;try{r=await l.launch({executablePath:o,defaultViewport:null,headless:!0,args:["--no-sandbox","--font-render-hinting=none","--disable-web-security"]}),a=await r.newPage();const s=await e.process(a,t);this.outputMetricsData.statusList.push(s)}catch(e){this.setError(t.index,e.message,n.ErrorCode.YJRASTERIZER_ERROR_JAVASCRIPT_ERROR)}finally{null!==a&&await a.close(),null!==r&&await r.close()}}else this.setError(t.index,"invalid task type",n.ErrorCode.YJRASTERIZER_ERROR_JAVASCRIPT_ERROR)}setError(t,e,o){this.outputMetricsData.statusList.push({index:t,errors:e,errorCode:o,success:!1})}}},9242:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.settings=void 0,e.settings={chromium_revision:"1056772",max_concurrency:4,nav_timeout:3e5}},4432:(t,e,o)=>{"use strict";const r=o(6069),a=o(7416),s=o(5674);(async()=>{const t=r(process.argv.slice(2)).usage("Usage: $0 -i <input json file path>").alias("i","inputFilePath").demandOption(["i"]).nargs("i",1).alias("o","outputFilePath").demandOption(["o"]).nargs("o",1).help("h").alias("t","tempDirectory").demandOption(["t"]).nargs("t",1).alias("h","help").argv;try{const e=t.inputFilePath,o=t.outputFilePath,r=t.tempDirectory,l=s.readFileSync(e,"utf8"),c=JSON.parse(l);await(new a.App).start(c,o,r)}catch(t){console.error(t)}})()},7457:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.RasterizerType=e.Platform=e.ErrorCode=e.OutputFileFormat=e.TaskType=void 0,function(t){t.RASTER="RASTER"}(e.TaskType||(e.TaskType={})),function(t){t.JPEG="jpeg",t.PNG="png",t.PDF="pdf"}(e.OutputFileFormat||(e.OutputFileFormat={})),function(t){t[t.YJRASTERIZER_ERROR_FILEACCESS_ERROR=12001]="YJRASTERIZER_ERROR_FILEACCESS_ERROR",t[t.YJRASTERIZER_ERROR_JAVASCRIPT_ERROR=12008]="YJRASTERIZER_ERROR_JAVASCRIPT_ERROR",t[t.YJRASTERIZER_INVALID_GLYPHS_PRESENT=13003]="YJRASTERIZER_INVALID_GLYPHS_PRESENT",t[t.YJRASTERIZER_ERROR_INVALID_POPUP=13007]="YJRASTERIZER_ERROR_INVALID_POPUP"}(e.ErrorCode||(e.ErrorCode={})),function(t){t.DARWIN="darwin",t.MAC="mac",t.LINUX="linux",t.WIN32="win32",t.WIN64="win64"}(e.Platform||(e.Platform={})),function(t){t.NODE="node",t.SVG="svg",t.TRUNCATED_TABLE="truncated_table",t.NODE_PDF="node_pdf"}(e.RasterizerType||(e.RasterizerType={}))},6795:(t,e,o)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Helper=void 0;const r=o(5622),a=o(6151),s=o(7457),l=o(2087),c=o(2884);e.Helper=class{static getPlatform(){const t=l.platform();if(t===s.Platform.DARWIN)return s.Platform.MAC;if(t===s.Platform.LINUX)return s.Platform.LINUX;if(t===s.Platform.WIN32)return"x64"===l.arch()?s.Platform.WIN64:s.Platform.WIN32;throw new a.ApplicationError("Unsupported platform: "+t,s.ErrorCode.YJRASTERIZER_ERROR_JAVASCRIPT_ERROR)}static getChromiumExecutablePath(){if(!process.env.CHROMIUM_PATH)throw new a.ApplicationError("CHROMIUM_PATH environment variable must be set",s.ErrorCode.YJRASTERIZER_ERROR_JAVASCRIPT_ERROR);const t=process.env.CHROMIUM_PATH,e=this.getPlatform();let o="";if(e===s.Platform.MAC)o=r.join(t,"Chromium.app","Contents","MacOS","Chromium");else if(e===s.Platform.LINUX)o=r.join(t,"chrome-wrapper");else{if(e!==s.Platform.WIN32&&e!==s.Platform.WIN64)throw new a.ApplicationError("Unsupported platform: "+e,s.ErrorCode.YJRASTERIZER_ERROR_JAVASCRIPT_ERROR);o=r.join(t,"chrome.exe")}return o}static isStringAValidUrl(t){try{return new URL(t),!0}catch(t){return!1}}static getImageResourcesPathInEpub(t){return c.sync(`${t}/**/*.{png,gif,jpg,jpeg,svg}`)}}},6151:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ApplicationError=void 0;class o extends Error{constructor(t,e){super(t),this.msg=t,this.code=e,Object.setPrototypeOf(this,o.prototype)}}e.ApplicationError=o},9359:(t,e,o)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.FontResolver=void 0;const r=o(6151),a=o(5622),s=o(5674),l=o(3825),c=o(706),i=o(7457),n=o(3289),b=o(9242);e.FontResolver=class{constructor(t){if(this.status={isSuccess:!0,errorMessage:""},this.rasterizerType=t,this.CSS_HOME_DIR=process.env.CSS_HOME_DIR,!this.CSS_HOME_DIR)throw new r.ApplicationError("CSS_HOME_DIR environment variable must be set",i.ErrorCode.YJRASTERIZER_ERROR_JAVASCRIPT_ERROR)}getStatus(){return this.status}async injectAmazonFontsAndPreventSystemFontFallback(t,e){const o=await t.target().createCDPSession();await o.send("DOM.enable"),await o.send("CSS.enable");const r=await o.send("DOM.getDocument");if(this.rasterizerType==i.RasterizerType.NODE_PDF&&"NoQuirksMode"!=r.root.compatibilityMode){const t="<!DOCTYPE html >"+await s.readFileSync(e,"utf8");await s.writeFileSync(e,t)}const l=a.join(this.CSS_HOME_DIR,"kss"),c=s.readFileSync(l,"utf8").replace(/src:url\((.*?)\)/g,`src:url("${this.CSS_HOME_DIR}/$1")`);await t.goto("file:///"+e,{waitUntil:"networkidle0",timeout:b.settings.nav_timeout}),await t.addStyleTag({content:c});const n=await o.send("DOM.getDocument"),_=await o.send("DOM.querySelectorAll",{nodeId:n.root.nodeId,selector:"*"});for(const e of _.nodeIds){const r=await o.send("CSS.getPlatformFontsForNode",{nodeId:e});0!=r.fonts.length&&(1==this.checkFontType(r.fonts)?await this.updateNodeToUseAmazonFontFamily(o,e,t,!0):3==this.checkFontType(r.fonts)&&await this.updateNodeToUseAmazonFontFamily(o,e,t,!1))}await t.evaluate((()=>{document.querySelectorAll("[amzn-raster-font-size]").forEach((t=>{t.style.fontSize=t.getAttribute("amzn-raster-font-size")}))}));const k=await t.content();s.writeFileSync(e,k)}async updateNodeToUseAmazonFontFamily(t,e,o,r){const a=await t.send("DOM.getAttributes",{nodeId:e}),s=a.attributes.indexOf("amzn-src-id"),l=a.attributes[s+1],c=await o.evaluate((t=>{const e=document.querySelector(`[amzn-src-id='${t}']`),o=window.getComputedStyle(e,null).getPropertyValue("font-family");return{nodeText:(t=>{if(!e)return"";const o=[...t.childNodes].find((t=>t.nodeType===Node.TEXT_NODE));return o?o.textContent.trim():""})(e),fontFamily:o}}),l),b=this.getAvailablePrimaryFontFromFamily(c.fontFamily),_=this.getFallBackFont(c.nodeText,b);_&&""!==_.trim()&&await o.evaluate(((t,e,o,r,a,s,l,c)=>{const i=document.querySelector(`[amzn-src-id='${t}']`);if(o){i.style.fontFamily=e;const t=window.getComputedStyle(i).getPropertyValue("font-size");l==s&&(a[c]?i.setAttribute("amzn-raster-font-size",parseFloat(t)*a[c]+"px"):i.setAttribute("amzn-raster-font-size",.84*parseFloat(t)+"px"))}else i.style.fontFamily=r+","+e}),l,_,r,c.fontFamily,n.default.FONT_SIZE_FALLBACK_MAP,i.RasterizerType.NODE_PDF,this.rasterizerType,b)}getAvailablePrimaryFontFromFamily(t){const e=t.split(",");for(const t in e)if(n.default.FONT_SIZE_FALLBACK_MAP[t.toLowerCase().replace(/"/g,"")])return t.toLowerCase().replace(/"/g,"");return t.split(",")[0].toLowerCase().replace(/"/g,"")}async registerFontInterceptionForDeobfuscation(t){const e=await t.target().createCDPSession();await e.send("Fetch.enable",{patterns:[{requestStage:"Response",resourceType:"Font"}]}),this.status.isSuccess=!0,await e.on("Fetch.requestPaused",(async t=>{const{requestId:o,request:r}=t;try{if(r.url.includes(this.CSS_HOME_DIR)&&!r.url.includes("code2000.ttf")){const t=await e.send("Fetch.getResponseBody",{requestId:o}),r=t.base64Encoded?l(t.body):t.body,a=this.deobfuscateFont(r),s=this.convertToBinaryString(a);await e.send("Fetch.fulfillRequest",{requestId:o,responseCode:200,body:c(s)})}else await e.send("Fetch.continueRequest",{requestId:o})}catch(t){this.status.isSuccess=!1,this.status.errorMessage=`Response "${o}" ${r.url} Failed. Error - ${t.message}`,await e.send("Fetch.continueRequest",{requestId:o})}}))}convertToBinaryString(t){let e="";const o=new Uint8Array(t),r=o.length;for(let t=0;t<r;t++)e+=String.fromCharCode(o[t]);return e}getFallBackFont(t,e){let o=0;const r={},a=[],s=[];for(;o<t.length;){const l=n.default.fixedCharCodeAt(t,o);if(null===l){o+=1;continue}const c=n.default.getUnicodeBlockForCodePoint(l);if(-1===s.indexOf(c)){s.push(c);let t=[];t=this.rasterizerType==i.RasterizerType.NODE_PDF?n.default.getMatchingFontForGivenBlockForPDFBacked(c,e):n.default.getMatchingFontForGivenBlock(c);for(const e of t)!0!==r[e]&&(r[e]=!0,a.push(e))}o+=1}return a.join(",")}checkFontType(t){let e=!1,o=!1;for(const r of t)r.isCustomFont?o=!0:e=!0;return o&&e?3:e?1:2}deobfuscateFont(t){const e=Buffer.from(t,"binary"),o=e.length,r=new Uint8Array(o),a=new Uint8Array(o);for(let t=0;t<o;t++){let a=t-13;a<0&&(a+=o),r[a]=e[t]}let s=0,l=0,c=1,i=0;for(;s<o;){i=l+c,l=c,c=i;let t=s+i;t>o&&(t=o);let e=s,n=t-1;for(;e<t;)a[e++]=r[n--];s+=i}return a}}},3289:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o={};o.BLOCKS=[{block_start:0,block:"Latin"},{block_start:128,block:"Latin-1_Supplement"},{block_start:256,block:"Latin_Extended-A"},{block_start:384,block:"Latin_Extended-B"},{block_start:592,block:"IPA_Extensions"},{block_start:688,block:"Spacing_Modifier_Letters"},{block_start:768,block:"Combining_Diacritical_Marks"},{block_start:880,block:"Greek_Coptic"},{block_start:1024,block:"Cyrillic"},{block_start:1328,block:"Armenian"},{block_start:1424,block:"Hebrew"},{block_start:1536,block:"Arabic"},{block_start:1792,block:"Syriac"},{block_start:1872,block:"Arabic"},{block_start:1920,block:"Thaana"},{block_start:1984,block:"Nko"},{block_start:2048,block:"Samaritan"},{block_start:2112,block:"Mandaic"},{block_start:2304,block:"Devanagari"},{block_start:2432,block:"Bengali"},{block_start:2560,block:"Gurmukhi"},{block_start:2688,block:"Gujarati"},{block_start:2816,block:"Oriya"},{block_start:2944,block:"Tamil"},{block_start:3072,block:"Telugu"},{block_start:3200,block:"Kannada"},{block_start:3328,block:"Malayalam"},{block_start:3456,block:"Sinhala"},{block_start:3584,block:"Thai"},{block_start:3712,block:"Lao"},{block_start:3840,block:"Tibetan"},{block_start:4096,block:"Myanmar"},{block_start:4256,block:"Georgian"},{block_start:4352,block:"Hangul"},{block_start:4608,block:"Ethiopic"},{block_start:5024,block:"Cherokee"},{block_start:5120,block:"Canadian_Syllabics"},{block_start:5760,block:"Ogham"},{block_start:5792,block:"Runic"},{block_start:5888,block:"Tagalog"},{block_start:5920,block:"Hanunoo"},{block_start:5952,block:"Buhid"},{block_start:5984,block:"Tagbanwa"},{block_start:6016,block:"Khmer"},{block_start:6144,block:"Mongolian"},{block_start:6320,block:"Canadian_Syllabics"},{block_start:6400,block:"Limbu"},{block_start:6480,block:"Tai_Le"},{block_start:6528,block:"New_Tai_Lue"},{block_start:6624,block:"Khmer"},{block_start:6656,block:"Buginese"},{block_start:6688,block:"Tai_Tham"},{block_start:6832,block:"Latin"},{block_start:6912,block:"Balinese"},{block_start:7040,block:"Sundanese"},{block_start:7104,block:"Batak"},{block_start:7168,block:"Lepcha"},{block_start:7248,block:"Ol_Chiki"},{block_start:7296,block:"Cyrillic"},{block_start:7360,block:"Sundanese"},{block_start:7376,block:"Vedic"},{block_start:7424,block:"Phonetic_Extensions"},{block_start:7552,block:"Phonetic_Extensions_Supplement"},{block_start:7616,block:"Combining_Diacritical_Marks_Supplement"},{block_start:7680,block:"Latin_Extended_Additional"},{block_start:7936,block:"Greek_Coptic"},{block_start:8192,block:"Punctuation"},{block_start:8304,block:"Letterlike"},{block_start:8400,block:"Combining_Diacritical_Marks_for_Symbols"},{block_start:8448,block:"Letterlike"},{block_start:8592,block:"Symbols"},{block_start:8704,block:"Mathematical"},{block_start:8960,block:"Symbols"},{block_start:9280,block:"Optical_Character_Recognition"},{block_start:9312,block:"Enclosed"},{block_start:9472,block:"Symbols"},{block_start:9984,block:"Dingbats"},{block_start:10176,block:"Mathematical"},{block_start:10224,block:"Symbols"},{block_start:10240,block:"Braille_Patterns"},{block_start:10496,block:"Symbols"},{block_start:10624,block:"Mathematical"},{block_start:11008,block:"Symbols"},{block_start:11264,block:"Glagolitic"},{block_start:11360,block:"Latin_Extended-C"},{block_start:11392,block:"Greek_Coptic"},{block_start:11520,block:"Georgian"},{block_start:11568,block:"Tifinagh"},{block_start:11648,block:"Ethiopic"},{block_start:11744,block:"Cyrillic"},{block_start:11776,block:"Punctuation"},{block_start:11904,block:"CJK_Radicals_Supplement"},{block_start:12032,block:"Kangxi_Radicals"},{block_start:12272,block:"Ideographic_Description_Characters"},{block_start:12288,block:"CJK_Symbols_And_Punctuation"},{block_start:12352,block:"Hiragana_Katakana"},{block_start:12544,block:"Bopomofo"},{block_start:12592,block:"Hangul"},{block_start:12688,block:"Kanbun"},{block_start:12704,block:"Bopomofo"},{block_start:12736,block:"CJK_Strokes"},{block_start:12784,block:"Hiragana_Katakana"},{block_start:12800,block:"Hangul"},{block_start:12832,block:"Enclosed"},{block_start:12896,block:"Hangul"},{block_start:12928,block:"Enclosed"},{block_start:13312,block:"CJK_Ideographs_BMP"},{block_start:19904,block:"Yijing_Hexagram_Symbols"},{block_start:19968,block:"CJK_Ideographs_BMP"},{block_start:40960,block:"Yi"},{block_start:42192,block:"Lisu"},{block_start:42240,block:"Vai"},{block_start:42560,block:"Cyrillic"},{block_start:42656,block:"Bamum"},{block_start:42752,block:"Modifier_Tone_Letters"},{block_start:42784,block:"Latin_Extended-D"},{block_start:43008,block:"Syloti_Nagri"},{block_start:43056,block:"Indic_Number_Forms"},{block_start:43072,block:"Phags_pa"},{block_start:43136,block:"Saurashtra"},{block_start:43232,block:"Devanagari"},{block_start:43264,block:"Kayah_Li"},{block_start:43312,block:"Rejang"},{block_start:43360,block:"Hangul"},{block_start:43392,block:"Javanese"},{block_start:43488,block:"Myanmar"},{block_start:43520,block:"Cham"},{block_start:43616,block:"Myanmar"},{block_start:43648,block:"Tai_Viet"},{block_start:43744,block:"Meetei_Mayek"},{block_start:43776,block:"Ethiopic"},{block_start:43824,block:"Latin"},{block_start:43888,block:"Cherokee"},{block_start:43968,block:"Meetei_Mayek"},{block_start:44032,block:"Hangul"},{block_start:55216,block:"Hangul"},{block_start:57344,block:"PUA"},{block_start:63744,block:"CJK_Ideographs_BMP"},{block_start:64256,block:"Alphabetic_Presentation_Forms"},{block_start:64272,block:"Armenian"},{block_start:64285,block:"Hebrew"},{block_start:64336,block:"Arabic"},{block_start:65040,block:"Vertical_Forms"},{block_start:65056,block:"Combining_Half_Marks"},{block_start:65072,block:"CJK_Symbols_And_Punctuation"},{block_start:65136,block:"Arabic"},{block_start:65280,block:"CJK_Symbols_And_Punctuation"},{block_start:65440,block:"Hangul"},{block_start:65504,block:"CJK_Symbols_And_Punctuation"},{block_start:65520,block:"Specials"},{block_start:65536,block:"Linear_B"},{block_start:65792,block:"Ancient_Greek"},{block_start:65936,block:"Letterlike"},{block_start:66e3,block:"Phaistos_Disc"},{block_start:66176,block:"Lycian"},{block_start:66208,block:"Carian"},{block_start:66272,block:"Coptic"},{block_start:66304,block:"Old_Italic"},{block_start:66352,block:"Gothic"},{block_start:66384,block:"Old_Permic"},{block_start:66432,block:"Ugaritic"},{block_start:66464,block:"Old_Persian"},{block_start:66560,block:"Deseret"},{block_start:66640,block:"Shavian"},{block_start:66688,block:"Osmanya"},{block_start:66816,block:"Elbasan"},{block_start:66864,block:"Caucasian_Albanian"},{block_start:67072,block:"Linear_A"},{block_start:67584,block:"Cypriot_Syllabary"},{block_start:67648,block:"Imperial_Aramaic"},{block_start:67680,block:"Palmyrene"},{block_start:67712,block:"Nabataean"},{block_start:67808,block:"Hatran"},{block_start:67840,block:"Phoenician"},{block_start:67872,block:"Lydian"},{block_start:67968,block:"Meroitic"},{block_start:68096,block:"Kharoshthi"},{block_start:68192,block:"Old_South_Arabian"},{block_start:68224,block:"Old_North_Arabian"},{block_start:68288,block:"Manichaean"},{block_start:68352,block:"Avestan"},{block_start:68416,block:"Inscriptional_Parthian"},{block_start:68448,block:"Inscriptional_Pahlavi"},{block_start:68480,block:"Psalter_Pahlavi"},{block_start:68608,block:"Old_Turkic"},{block_start:68736,block:"Old_Hungarian"},{block_start:69216,block:"Rumi_Numeral_Symbols"},{block_start:69632,block:"Brahmi"},{block_start:69760,block:"Kaithi"},{block_start:69840,block:"Sora_Sompeng"},{block_start:69888,block:"Chakma"},{block_start:69968,block:"Mahajani"},{block_start:70016,block:"Sharada"},{block_start:70112,block:"Sinhala"},{block_start:70144,block:"Khojki"},{block_start:70272,block:"Multani"},{block_start:70320,block:"Khudawadi"},{block_start:70400,block:"Grantha"},{block_start:70656,block:"Newa"},{block_start:70784,block:"Tirhuta"},{block_start:71040,block:"Siddham"},{block_start:71168,block:"Modi"},{block_start:71264,block:"Mongolian"},{block_start:71296,block:"Takri"},{block_start:71424,block:"Ahom"},{block_start:71840,block:"Warang_Citi"},{block_start:72384,block:"Pau_Cin_Hau"},{block_start:72704,block:"Bhaiksuki"},{block_start:72816,block:"Marchen"},{block_start:73728,block:"Cuneiform"},{block_start:77824,block:"Egyptian_Hieroglyphs"},{block_start:82944,block:"Anatolian_Hieroglyphs"},{block_start:92160,block:"Bamum"},{block_start:92736,block:"Mro"},{block_start:92880,block:"Bassa_Vah"},{block_start:92928,block:"Pahawh_Hmong"},{block_start:93952,block:"Miao"},{block_start:94208,block:"Tangut"},{block_start:110592,block:"Hiragana_Katakana"},{block_start:113664,block:"Duployan"},{block_start:118784,block:"Musical"},{block_start:119296,block:"Ancient_Greek"},{block_start:119552,block:"Tai_Xuan_Jing_Symbols"},{block_start:119648,block:"Counting_Rod_Numerals"},{block_start:119808,block:"Mathematical"},{block_start:120832,block:"Sutton_SignWriting"},{block_start:122880,block:"Glagolitic"},{block_start:124928,block:"Mende_Kikakui"},{block_start:125184,block:"Adlam"},{block_start:126464,block:"Arabic"},{block_start:126976,block:"Mahjong_Tiles"},{block_start:127024,block:"Domino_Tiles"},{block_start:127136,block:"Playing_Cards"},{block_start:127232,block:"Enclosed"},{block_start:127744,block:"Symbols"},{block_start:131072,block:"CJK_Ideographs_SIP"},{block_start:983040,block:"PUA"},{block_start:1114112,block:"Invalid"}],o.BLOCK_TO_FONT_MAP={Latin:["ccl","ds","bo","ba"],"Latin-1_Supplement":["ccl","ds","bo","ba"],"Latin_Extended-A":["ccl","ds","bo","ba"],Greek_Coptic:["bo","obs-c2000","unobs-c2000"],Cyrillic:["ccl","bo","ba"],Gujarati:["sa"],Malayalam:["ml"],Tamil:["mu"],CJK_Ideographs_SIP:["tbm","ss","songtc","nsk"],CJK_Ideographs_BMP:["tbm","ss","songtc","nsk"],Hiragana_Katakana:["tbm","tbg"],CJK_Radicals_Supplement:["heitc","obs-c2000","unobs-c2000"],Kanbun:["tbm","tbg"],Bopomofo:["heitc"],Ideographic_Description_Characters:["ss","stH","heitc","myht"],Vertical_Forms:["songtc","tbm","tbg"],Punctuation:["bo"],Arabic:["nn","dm","sk"],Devanagari:["de"],Vedic:["de"],Indic_Number_Forms:["de","sa"],Specials:["bo"],Hangul:["nsk","ss","songtc","tbm"],Default:["obs-c2000","unobs-c2000"]},o.BLOCK_TO_FONT_MAP_PDF={Latin:["bo"],Latin_Serif:["bo"],"Latin_Sans-Serif":["em"],"Latin-1_Supplement":["bo"],"Latin_Extended-A":["bo"],Greek_Coptic:["bo","obs-c2000","unobs-c2000"],Cyrillic:["bo"],Gujarati:["sa"],Malayalam:["ml"],Tamil:["mu"],CJK_Ideographs_SIP:["tbm","ss","songtc","nsk"],CJK_Ideographs_BMP:["tbm","ss","songtc","nsk"],Hiragana_Katakana:["tbm","tbg"],CJK_Radicals_Supplement:["heitc","obs-c2000","unobs-c2000"],Kanbun:["tbm","tbg"],Bopomofo:["heitc"],Ideographic_Description_Characters:["ss","stH","heitc","myht"],Vertical_Forms:["songtc","tbm","tbg"],Punctuation:["bo"],Arabic:["nn","dm","sk"],Devanagari:["de"],Vedic:["de"],Indic_Number_Forms:["de","sa"],Specials:["bo"],Hangul:["nsk","ss","songtc","tbm"],Default:["obs-c2000","unobs-c2000"]},o.FONT_TO_TYPEFACE_MAP={georgia:1,arial:2,"sans-serif":2,calibri:2,"helvetica neue":2,"times new roman":1,serif:1,helvetica:2,baskerville:1,palatino:1,verdana:2,times:1},o.FONT_SIZE_FALLBACK_MAP={"times new roman":.84,times:.88,serif:.86,helvetica:.965,"helvetica neue":.965,calibri:.89,georgia:.91,arial:.96,"sans-serif":.989,palatino:.89,baskerville:.87},o.MAX_CODE_POINT=1114111,o.MIN_CODE_POINT=0,o.BLOCKS_WITH_UNSUPPORTED_COMBINATIONS=["Arabic","Devanagari","Bengali","Gurmukhi","Hangul","Malayalam","Musical","Combining_Diacritical_Marks","Combining_Diacritical_Marks_for_Symbols","Combining_Diacritical_Marks_Supplement","Combining_Half_Marks"],o.getMatchingFontForGivenBlock=function(t){return o.BLOCK_TO_FONT_MAP[t]?o.BLOCK_TO_FONT_MAP[t]:o.BLOCK_TO_FONT_MAP.Default},o.getMatchingFontForGivenBlockForPDFBacked=function(t,e){return"Latin"==t&&1==o.FONT_TO_TYPEFACE_MAP[e]?o.BLOCK_TO_FONT_MAP_PDF.Latin_Serif:"Latin"==t&&2==o.FONT_TO_TYPEFACE_MAP[e]?o.BLOCK_TO_FONT_MAP_PDF["Latin_Sans-Serif"]:o.BLOCK_TO_FONT_MAP_PDF[t]?o.BLOCK_TO_FONT_MAP_PDF[t]:o.BLOCK_TO_FONT_MAP_PDF.Default},o.getUnicodeBlockForCodePoint=function(t){if(t<this.MIN_CODE_POINT||t>this.MAX_CODE_POINT)return null;let e=this.BLOCKS.length,o=0,r=Math.floor(e/2);for(;e-o>1;)t>=this.BLOCKS[r].block_start?o=r:e=r,r=Math.floor((e+o)/2);return this.BLOCKS[r].block},o.fixedCharCodeAt=function(t,e){e=e||0;const o=t.charCodeAt(e);let r,a;if(55296<=o&&o<=56319){if(r=o,a=t.charCodeAt(e+1),isNaN(a))throw"High surrogate not followed by low surrogate in fixedCharCodeAt()";return 1024*(r-55296)+(a-56320)+65536}return!(56320<=o&&o<=57343)&&o},o.isBlockCombinationsValid=function(t){if(t.length<=1)return!0;for(let e=0;e<o.BLOCKS_WITH_UNSUPPORTED_COMBINATIONS.length;e+=1){const r=o.BLOCKS_WITH_UNSUPPORTED_COMBINATIONS[e];if(-1!==t.indexOf(r))return!1}return!0},e.default=o},1276:(t,e,o)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SourceOptimiser=void 0;const r=o(9242),a=o(5674),s=o(6151),l=o(7457),c=o(6795);e.SourceOptimiser=class{async optimiseSourceEpub(t,e){e.externalImageResourceList=c.Helper.getImageResourcesPathInEpub(e.tempDir),await t.goto("file:///"+e.inputHtmlFile,{waitUntil:"networkidle0",timeout:r.settings.nav_timeout}),e.fileExtension=e.inputHtmlFile.split(".").pop();const o=await t.evaluate((t=>{const e=(e,o)=>0==t.externalImageResourceList.length?-1:o?t.externalImageResourceList.find((t=>null!=t.toLocaleLowerCase().match(e.toLocaleLowerCase()))):t.externalImageResourceList.find((t=>null!=t.match(e)));document.body.style.fontSize||(document.body.style.fontSize="12pt");const o=t=>{try{let e=t.style.marginTop,o=t.style.marginBottom,r=t.style.marginLeft,a=t.style.marginRight;const s=(t=>{const e=t.ownerDocument.styleSheets,o={};for(let t=0;t<e.length;t++)for(let r=0;r<e[t].cssRules.length;r++){let a=e[t].cssRules[r].cssText.replace(/[\n\r]/g,"").replace(/\s/g,"").split("}");a=a.filter(Boolean),a.forEach((t=>{const e=t.split("{"),r=e[0]&&e[0].trim(),a=(e[1]&&e[1].trim()).split(";");r.split(",").forEach((t=>{o[t.trim()]?o[t.trim()]=o[t.trim()].concat(a):o[t.trim()]=a}))}))}return o})(t);s.body&&s.body.forEach((t=>{const s=t.split(":")[0].trim();"margin"==s&&(e=t.split(":")[1],o=t.split(":")[1],r=t.split(":")[1],a=t.split(":")[1]),"margin-top"==s&&(e=t.split(":")[1]),"margin-bottom"==s&&(o=t.split(":")[1]),"margin-left"==s&&(r=t.split(":")[1]),"margin-right"==s&&(a=t.split(":")[1])})),""===e&&(t.style.marginTop="0px"),""===r&&(t.style.marginLeft="0px"),""===o&&(t.style.marginBottom="0px"),""===a&&(t.style.marginRight="0px")}catch(t){const e=document.head.firstElementChild,o=document.createElement("style");o.textContent="\n                            body {\n                                margin: 0px;\n                            }\n                        ",e?document.head.insertBefore(o,e):document.head.appendChild(o)}};return document.querySelectorAll("*").forEach((r=>{"html"==t.fileExtension&&"br"==r.nodeName.toLocaleLowerCase()&&(t=>{null===t.getAttribute("amzn-src-id")&&t.parentNode.removeChild(t)})(r),"svg"==r.nodeName.toLocaleLowerCase()&&(e=>{const o=e.getAttribute("height");if(null!=o&&!o.trim().endsWith("%"))return;const r=e.style.height;if(null==o&&null!=r&&!r.trim().endsWith("%"))return;const a=parseInt(window.getComputedStyle(e).height);!isNaN(a)&&a>t.viewportHeight&&(e.style.maxHeight=t.viewportHeight+"px")})(r),null!=r.style.background&&(t=>{const e=t.style.background.split(" ");2==e.length&&e[0].match("url")&&(e[1].match("repeat")||e[1].match("no-repeat"))&&(t.style.removeProperty("background"),t.style.backgroundImage=e[0],t.style.backgroundRepeat=e[1])})(r),"a"===r.nodeName.toLocaleLowerCase()&&(t=>{for(;null!=t;)0==parseInt(window.getComputedStyle(t).opacity)&&(t.style.opacity="0.01"),t=t.parentElement})(r),"body"===r.nodeName.toLocaleLowerCase()&&o(r),(o=>{const r=window.getComputedStyle(o).backgroundImage;if(r.length>0&&t.externalImageResourceList.length>0){const t=r.lastIndexOf("/"),a=r.lastIndexOf(")"),s=r.substring(t+1,a-1);if(!new RegExp(/[^\s]+(.*?).(jpe?g|png|gif|bmp|svg|avif|jfif|webp|ico|cur|tif?f)$/).test(s))return;if(void 0!==e(s,!1))return;const l=e(s,!0);if(void 0===l)return;o.style.backgroundImage="url("+l+")"}})(r),(e=>{var o,r,a,s;const l=window.getComputedStyle(e).backgroundImage,c=window.getComputedStyle(e).backgroundSize;if(null!=l&&"none"!==l&&l.length>0&&"auto"===c)null!=(null===(r=null===(o=t.additionalInfo)||void 0===o?void 0:o.imageDimensions)||void 0===r?void 0:r.find((t=>l.includes(t.fileName))))&&(e.style.backgroundSize="contain");else if(e instanceof HTMLImageElement){const o=window.getComputedStyle(e).width,r=window.getComputedStyle(e).height,l=null===(s=null===(a=t.additionalInfo)||void 0===a?void 0:a.imageDimensions)||void 0===s?void 0:s.find((t=>e.src.includes(t.fileName)));if(null!=l){const t=l.optimisedDimension.trim().split("x"),a=l.originalDimension.trim().split("x");o===`${t[0]}px`&&r===`${t[1]}px`&&(e.style.width=`${a[0]}px`,e.style.height=`${a[1]}px`)}}})(r)})),{status:!0}}),e);if(!1===o.status)throw new s.ApplicationError(o.error,l.ErrorCode.YJRASTERIZER_ERROR_JAVASCRIPT_ERROR);const i=await t.content();a.writeFileSync(e.inputHtmlFile,i)}}},5198:(t,e,o)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.RasterTask=void 0;const r=o(2277),a=o(9359),s=o(1276),l=o(5622),c=o(5674),i=o(8835),n=o(7457),b=o(6151),_=o(6795),k=o(9242);e.RasterTask=class{async process(t,e){const o={index:e.index,sourceFile:e.sourceFile,success:!1};try{const{viewportWidth:r,viewportHeight:u}=e;if(e.fullPageRaster&&(!r||!u))throw new b.ApplicationError("viewport data is necessary for full page raster",n.ErrorCode.YJRASTERIZER_ERROR_JAVASCRIPT_ERROR);const d=l.extname(e.sourceFile);let p=e.sourceFile;if(".xhtml"===d&&(p=e.inputFileToRasterURI),_.Helper.isStringAValidUrl(p)&&(p=i.fileURLToPath(p)),!c.existsSync(p))throw new b.ApplicationError("source file not found",n.ErrorCode.YJRASTERIZER_ERROR_FILEACCESS_ERROR);t.on("console",(t=>console.log(t.text()))),await t.setViewport({width:r,height:u,deviceScaleFactor:2});const m=new s.SourceOptimiser;await m.optimiseSourceEpub(t,{inputHtmlFile:p,viewportWidth:r,viewportHeight:u,tempDir:e.tempDirectory,additionalInfo:e.additionalInfo});const[h,g]=await this.encloseInIframe(p,r,u),f=new a.FontResolver(e.jsRasterizerType);if(await f.injectAmazonFontsAndPreventSystemFontFallback(t,g),await f.registerFontInterceptionForDeobfuscation(t),await t.goto("file:///"+h,{waitUntil:"networkidle0",timeout:k.settings.nav_timeout}),!f.getStatus().isSuccess)throw new b.ApplicationError(f.getStatus().errorMessage,n.ErrorCode.YJRASTERIZER_INVALID_GLYPHS_PRESENT);const y=await t.$("iframe"),R=await y.contentFrame();await this.prepareDomForPopUpRaster(e,R);let S={width:r,height:u};if(!e.fullPageRaster){S=await R.evaluate((t=>{const e=document.querySelector(`[amzn-src-id='${t}']`).getBoundingClientRect();return JSON.parse(JSON.stringify(e))}),e.nodeID),await t.evaluate((t=>{const e=document.querySelector("iframe");e.setAttribute("height",t.height+""),e.setAttribute("width",t.width+"")}),S);const o=await R.$(`[amzn-src-id='${e.nodeID}']`);await o.evaluate((t=>{t.scrollIntoView()}))}await this.raster(t,e,S),o.success=!0}catch(t){o.success=!1,t instanceof b.ApplicationError?(o.errors=t.msg,o.errorCode=t.code):(o.errors=t.toString(),o.errorCode=n.ErrorCode.YJRASTERIZER_ERROR_JAVASCRIPT_ERROR),console.error(t)}return o}async prepareDomForPopUpRaster(t,e){if(!0===t.rasterPopup){const o=await e.evaluate((t=>{const e=document.querySelector(`[amzn-src-id='${t}']`),o=(t=>{if(!t)return!1;const e=t.getAttribute("data-app-amzn-magnify");if(!e||!(t=>{try{JSON.parse(t)}catch(t){return!1}return!0})(e))return!1;const o=JSON.parse(e).targetId,r=document.getElementById(o);return r||!1})(e);if(!1!==o){o.innerHTML=e.innerHTML;document.querySelectorAll("*").forEach((t=>{t.style.visibility="hidden"}));const t=document.querySelectorAll(`#${o.id}, #${o.id} *`);o.style.display="block",t.forEach((t=>{t.style.visibility="visible"}));return document.querySelector("html").style.background="#fff0",{success:!0,targetAmznSrcId:o.getAttribute("amzn-src-id")}}return{success:!1}}),t.nodeID);if(!o.success)throw new b.ApplicationError("invalid popup",n.ErrorCode.YJRASTERIZER_ERROR_INVALID_POPUP);t.nodeID=o.targetAmznSrcId}}async raster(t,e,o){const r=e.outputPath;switch(await c.ensureDir(l.dirname(r)),e.format.toLowerCase()){case n.OutputFileFormat.PDF:await this.printPDF(t,r,o);break;case n.OutputFileFormat.JPEG:case n.OutputFileFormat.PNG:await this.rasterAsImage(t,r,o,e.format);break;default:throw new b.ApplicationError("Unsupported raster file format",n.ErrorCode.YJRASTERIZER_ERROR_JAVASCRIPT_ERROR)}}async printPDF(t,e,o){await t.pdf({path:e,width:o.width,height:o.height,margin:{top:0,left:0,right:0,bottom:0},preferCSSPageSize:!0,printBackground:!0,omitBackground:!0,pageRanges:"1-1"})}async rasterAsImage(t,e,o,r){await t.screenshot({path:e,type:r,omitBackground:!0,clip:{x:0,y:0,width:o.width,height:o.height}})}async encloseInIframe(t,e,o){const a=l.dirname(t);await c.ensureDir(a);const s=l.join(a,`frame_${r.v4()}.html`);c.copyFileSync(t,s);const i=`\n                        <html>\n                         <body style="margin: 0; border: 0">\n                          <iframe id="amzn-root-iframe" sandbox="allow-same-origin" style="border: 0;" width="${e||"100%"}" height="${o||"100%"}"  src="file:///${s}"></iframe>\n                           </body>\n                        </html>\n                         `,n=l.join(a,`host_${r.v4()}.html`);return c.writeFileSync(n,i),[n,s]}}},7909:(t,e,o)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TaskFactory=void 0;const r=o(7457),a=o(5198);e.TaskFactory=class{static getProcessor(t){switch(t.type){case r.TaskType.RASTER:return new a.RasterTask;default:return null}}}},6376:t=>{function e(t){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}e.keys=()=>[],e.resolve=e,e.id=6376,t.exports=e},6944:t=>{function e(t){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}e.keys=()=>[],e.resolve=e,e.id=6944,t.exports=e},4907:t=>{function e(t){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}e.keys=()=>[],e.resolve=e,e.id=4907,t.exports=e},2357:t=>{"use strict";t.exports=require("assert")},4293:t=>{"use strict";t.exports=require("buffer")},1040:t=>{"use strict";t.exports=require("bufferutil")},3129:t=>{"use strict";t.exports=require("child_process")},7619:t=>{"use strict";t.exports=require("constants")},6417:t=>{"use strict";t.exports=require("crypto")},8614:t=>{"use strict";t.exports=require("events")},5747:t=>{"use strict";t.exports=require("fs")},9225:t=>{"use strict";t.exports=require("fs/promises")},8605:t=>{"use strict";t.exports=require("http")},7211:t=>{"use strict";t.exports=require("https")},1631:t=>{"use strict";t.exports=require("net")},2087:t=>{"use strict";t.exports=require("os")},5622:t=>{"use strict";t.exports=require("path")},4213:t=>{"use strict";t.exports=require("punycode")},1058:t=>{"use strict";t.exports=require("readline")},2413:t=>{"use strict";t.exports=require("stream")},4304:t=>{"use strict";t.exports=require("string_decoder")},4016:t=>{"use strict";t.exports=require("tls")},3867:t=>{"use strict";t.exports=require("tty")},8835:t=>{"use strict";t.exports=require("url")},6993:t=>{"use strict";t.exports=require("utf-8-validate")},1669:t=>{"use strict";t.exports=require("util")},8761:t=>{"use strict";t.exports=require("zlib")}},r={};function a(t){var e=r[t];if(void 0!==e)return e.exports;var s=r[t]={id:t,loaded:!1,exports:{}};return o[t].call(s.exports,s,s.exports,a),s.loaded=!0,s.exports}a.m=o,a.c=r,a.x=()=>{var t=a.O(void 0,[736],(()=>a(4432)));return t=a.O(t)},t=[],a.O=(e,o,r,s)=>{if(!o){var l=1/0;for(n=0;n<t.length;n++){for(var[o,r,s]=t[n],c=!0,i=0;i<o.length;i++)(!1&s||l>=s)&&Object.keys(a.O).every((t=>a.O[t](o[i])))?o.splice(i--,1):(c=!1,s<l&&(l=s));c&&(t.splice(n--,1),e=r())}return e}s=s||0;for(var n=t.length;n>0&&t[n-1][2]>s;n--)t[n]=t[n-1];t[n]=[o,r,s]},a.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return a.d(e,{a:e}),e},a.d=(t,e)=>{for(var o in e)a.o(e,o)&&!a.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},a.f={},a.e=t=>Promise.all(Object.keys(a.f).reduce(((e,o)=>(a.f[o](t,e),e)),[])),a.u=t=>"vendor.js",a.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),a.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},a.nmd=t=>(t.paths=[],t.children||(t.children=[]),t),(()=>{var t={879:1};a.O.require=e=>t[e];a.f.require=(e,o)=>{t[e]||(e=>{var o=e.modules,r=e.ids,s=e.runtime;for(var l in o)a.o(o,l)&&(a.m[l]=o[l]);s&&s(a);for(var c=0;c<r.length;c++)t[r[c]]=1;a.O()})(require("./"+a.u(e)))}})(),e=a.x,a.x=()=>(a.e(736),e());a.x()})();